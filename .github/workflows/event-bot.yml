name: LivePing Event Bot

on:
  schedule:
    # Run every minute
    - cron: '* * * * *'
  workflow_dispatch: # Allow manual trigger
  
permissions:
  contents: read

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      
      - name: Run event bot
        id: bot
        env:
          EVENT_URL: ${{ secrets.EVENT_URL }}
          LOGIN_EMAIL: ${{ secrets.LOGIN_EMAIL }}
          LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
        run: |
          set +e
          npm run bot > bot_output.log 2>&1
          BOT_EXIT_CODE=$?
          cat bot_output.log
          
          if [ $BOT_EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Bought successfully" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "message=Purchase failed" >> $GITHUB_OUTPUT
          fi
          
          # Save log for email
          echo "BOT_LOG<<EOF" >> $GITHUB_ENV
          cat bot_output.log >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          exit $BOT_EXIT_CODE
        continue-on-error: true
      
      - name: Publish GitHub notification
        if: always()
        uses: actions/github-script@v7
        env:
          STATUS: ${{ steps.bot.outputs.status }}
          MESSAGE: ${{ steps.bot.outputs.message }}
          BOT_LOG: ${{ env.BOT_LOG }}
          NOTIFY_USERS: ${{ vars.NOTIFY_USERS }}
        with:
          script: |
            const status = process.env.STATUS || 'unknown';
            const message = process.env.MESSAGE || 'No message';
            const log = process.env.BOT_LOG || 'No log output captured.';
            const mentions = (process.env.NOTIFY_USERS || '').trim();

            const title = `LivePing Bot: ${status === 'success' ? '✅ Bought successfully' : '❌ Purchase failed'}`;
            const lines = [
              'LivePing Bot Execution Report',
              '=============================',
              '',
              `Status: ${status === 'success' ? '✅ SUCCESS' : '❌ FAILED'}`,
              `Message: ${message}`,
              '',
              `Workflow Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              '',
              'Bot Output Log:',
              '---------------',
              log
            ];

            if (mentions) {
              lines.push('', `Notify: ${mentions}`);
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: lines.join('\n')
            });
