name: LivePing Event Bot

on:
  workflow_dispatch:
    inputs:
      event_url:
        description: "Event URL override (defaults to secret EVENT_URL)"
        required: false
        type: string
      login_email:
        description: "Login email override (defaults to secret LOGIN_EMAIL)"
        required: false
        type: string
      login_password:
        description: "Login password override (defaults to secret LOGIN_PASSWORD)"
        required: false
        type: string
      mail_to:
        description: "Notification recipient override (defaults to secret MAIL_TO)"
        required: false
        type: string
  
permissions:
  contents: read

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      
      - name: Run event bot loop (max 10 minutes)
        id: bot
        env:
          EVENT_URL: ${{ secrets.EVENT_URL }}
          LOGIN_EMAIL: ${{ secrets.LOGIN_EMAIL }}
          LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
          INPUT_EVENT_URL: ${{ inputs.event_url }}
          INPUT_LOGIN_EMAIL: ${{ inputs.login_email }}
          INPUT_LOGIN_PASSWORD: ${{ inputs.login_password }}
          MAIL_TO_DEFAULT: ${{ secrets.MAIL_TO }}
          INPUT_MAIL_TO: ${{ inputs.mail_to }}
        run: |
          set +e
          LOG_FILE="bot_output.log"
          : > "$LOG_FILE"
          
          start_time=$(date +%s)
          MAX_RUNTIME_SECONDS=600
          SLEEP_DURATION_SECONDS=300
          MAX_RUNTIME_MINUTES=$((MAX_RUNTIME_SECONDS / 60))
          SLEEP_DURATION_MINUTES=$((SLEEP_DURATION_SECONDS / 60))
          deadline=$((start_time + MAX_RUNTIME_SECONDS))
          EMAIL_REGEX='^[^@[:space:]]+@[^@[:space:]]+\.[^@[:space:]]+$'
          iteration=1
          success_iteration=""
          last_exit=0
          runs=0
          MAIL_TO_VALUE=$MAIL_TO_DEFAULT
          
          # Returns true when the provided value contains any non-whitespace characters.
          has_content() {
            local value="$1"
            value="${value#"${value%%[![:space:]]*}"}"
            value="${value%"${value##*[![:space:]]}"}"
            [[ -n "$value" ]]
          }
          
          if has_content "${INPUT_EVENT_URL:-}" && [[ "$INPUT_EVENT_URL" =~ ^https?://[A-Za-z0-9.-]+\.[A-Za-z]{2,}(:[0-9]+)?(/.*)?$ ]]; then
            export EVENT_URL="$INPUT_EVENT_URL"
          fi
          
          if has_content "${INPUT_LOGIN_EMAIL:-}" && [[ "$INPUT_LOGIN_EMAIL" =~ $EMAIL_REGEX ]]; then
            export LOGIN_EMAIL="$INPUT_LOGIN_EMAIL"
          fi
          
          if has_content "${INPUT_LOGIN_PASSWORD:-}"; then
            export LOGIN_PASSWORD="$INPUT_LOGIN_PASSWORD"
          fi
          
          if has_content "${INPUT_MAIL_TO:-}" && [[ "$INPUT_MAIL_TO" =~ $EMAIL_REGEX ]]; then
            MAIL_TO_VALUE="$INPUT_MAIL_TO"
          fi
          
          # Strip newline characters to avoid breaking subsequent environment parsing.
          MAIL_TO_VALUE=${MAIL_TO_VALUE//$'\n'/}
          MAIL_TO_VALUE=${MAIL_TO_VALUE//$'\r'/}
          echo "MAIL_TO_VALUE=$MAIL_TO_VALUE" >> "$GITHUB_ENV"
          
          echo "Starting event bot loop for up to $MAX_RUNTIME_MINUTES minutes..." | tee -a "$LOG_FILE"
          
          while true; do
            loop_start=$(date +%s)
            if [ "$loop_start" -ge "$deadline" ]; then
              echo "Time limit reached before iteration $iteration could start. Stopping loop." | tee -a "$LOG_FILE"
              break
            fi
            
            now_utc=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "----- Iteration $iteration ($now_utc) -----" | tee -a "$LOG_FILE"
            
            npm run bot >> "$LOG_FILE" 2>&1
            last_exit=$?
            echo "Iteration $iteration exit code: $last_exit" | tee -a "$LOG_FILE"
            runs=$((runs + 1))
            
            if [ "$last_exit" -eq 0 ] && [ -z "$success_iteration" ]; then
              success_iteration=$iteration
            fi
            
            now=$(date +%s)
            if [ "$now" -ge "$deadline" ]; then
              echo "Time limit reached after iteration $iteration. Stopping loop." | tee -a "$LOG_FILE"
              break
            fi
            if [ $((now + SLEEP_DURATION_SECONDS)) -ge "$deadline" ]; then
              echo "Time limit reached or not enough time for another run. Stopping loop." | tee -a "$LOG_FILE"
              break
            fi
            
            echo "Sleeping $SLEEP_DURATION_MINUTES minutes before next attempt..." | tee -a "$LOG_FILE"
            sleep "$SLEEP_DURATION_SECONDS"
            iteration=$((iteration + 1))
          done
          
          if [ -n "$success_iteration" ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "message=Succeeded on iteration $success_iteration" >> "$GITHUB_OUTPUT"
            final_exit=0
          else
            echo "status=failed" >> "$GITHUB_OUTPUT"
            echo "message=All attempts failed within $MAX_RUNTIME_MINUTES minutes" >> "$GITHUB_OUTPUT"
            final_exit=$last_exit
          fi
          
          plural_suffix=$([ $runs -eq 1 ] && echo '' || echo s)
          echo "Loop complete after $runs iteration${plural_suffix}. Final exit code: $final_exit" | tee -a "$LOG_FILE"
          
          echo "BOT_LOG<<EOF" >> "$GITHUB_ENV"
          cat "$LOG_FILE" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"
          
          exit $final_exit
        continue-on-error: true
      
      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: 'LivePing Bot: ${{ steps.bot.outputs.status == ''success'' && ''✅ Bought successfully'' || ''❌ Purchase failed'' }}'
          to: ${{ env.MAIL_TO_VALUE }}
          from: LivePing Bot <${{ secrets.MAIL_USERNAME }}>
          body: |
            LivePing Bot Execution Report
            =============================
            
            Status: ${{ steps.bot.outputs.status == 'success' && '✅ SUCCESS' || '❌ FAILED' }}
            Message: ${{ steps.bot.outputs.message }}
            
            Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Bot Output Log:
            ---------------
            ${{ env.BOT_LOG }}
          priority: high
