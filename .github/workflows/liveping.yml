name: LivePing Manual Runner

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "Target event URL to monitor"
        required: true
        type: string
      start_time:
        description: "ISO start time (UTC). Bot exits until this time."
        required: false
        default: ""
        type: string

permissions:
  contents: read

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      LOOP_WINDOW_SECONDS: 600
      LOOP_SLEEP_SECONDS: 300
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Run LivePing loop
        id: run-bot
        env:
          TARGET_URL: ${{ inputs.target_url }}
          START_TIME: ${{ inputs.start_time }}
          LOGIN_EMAIL: ${{ secrets.LOGIN_EMAIL }}
          LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
        run: |
          end=$(( $(date +%s) + ${LOOP_WINDOW_SECONDS:-600} ))
          status="failure"
          message="Purchase failed"
          attempt=1
          while [ "$(date +%s)" -lt "$end" ]; do
            echo "::group::Bot attempt ${attempt}"
            if npm run bot; then
              status="success"
              message="Bought successfully"
              echo "::endgroup::"
              break
            else
              exit_code=$?
              if [ "$exit_code" -eq 3 ]; then
                message="Start time not reached"
              else
                message="Purchase failed"
              fi
            fi
            echo "::endgroup::"
            if [ "$(date +%s)" -ge "$end" ]; then
              break
            fi
            echo "Sleeping 5 minutes before next attempt..."
            sleep "${LOOP_SLEEP_SECONDS:-300}"
            attempt=$((attempt + 1))
          done
          echo "last_status=${status}" >> "$GITHUB_OUTPUT"
          echo "last_message=${message}" >> "$GITHUB_OUTPUT"
          if [ "${status}" != "success" ]; then
            exit 1
          fi

      - name: Send email notification
        if: always() && steps.run-bot.outputs.last_status != ''
        uses: actions/github-script@v7
        env:
          LAST_STATUS: ${{ steps.run-bot.outputs.last_status }}
          LAST_MESSAGE: ${{ steps.run-bot.outputs.last_message }}
          TARGET_URL: ${{ inputs.target_url }}
          START_TIME: ${{ inputs.start_time }}
          NOTIFY_USERS: ${{ vars.NOTIFY_USERS }}
        with:
          script: |
            const status = process.env.LAST_STATUS || 'unknown';
            const message = process.env.LAST_MESSAGE || 'No message';
            const target = process.env.TARGET_URL || 'N/A';
            const start = process.env.START_TIME || 'N/A';
            const mentions = (process.env.NOTIFY_USERS || '').trim();

            const title = `LivePing Bot: ${status === 'success' ? '✅ Success' : '❌ Failure'}`;
            const lines = [
              'LivePing Bot Execution Report',
              '',
              `Status: ${status}`,
              `Message: ${message}`,
              `Target URL: ${target}`,
              `Start Time: ${start}`,
              `Workflow Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            ];

            if (mentions) {
              lines.push('', `Notify: ${mentions}`);
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: lines.join('\n')
            });
